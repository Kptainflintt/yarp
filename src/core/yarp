#!/bin/bash
# YARP CLI - Interface en ligne de commande

YARP_DIR="/opt/yarp"
CONFIG_FILE="/etc/yarp/config.yaml"
YARP_VERSION=$(cat "$YARP_DIR/VERSION" 2>/dev/null || echo "inconnue")

show_help() {
    cat <<EOF
YARP - YAML Alpine Router Project
Version $YARP_VERSION

Usage: yarp <command> [options]

Commandes:
    apply           Appliquer la configuration
    validate        Valider la configuration
    show            Afficher la configuration
    status          Afficher l'état du système
    reload          Recharger la configuration
    version         Afficher la version

Exemples:
    yarp apply      # Appliquer la configuration
    yarp status     # Voir l'état du réseau
    yarp validate   # Valider le fichier YAML

EOF
}

cmd_apply() {
    echo "Application de la configuration..."
    "$YARP_DIR/bin/yarp-apply"
}

cmd_validate() {
    python3 "$YARP_DIR/core/yarp_config.py" validate
}

cmd_show() {
    python3 "$YARP_DIR/core/yarp_config.py" show
}

cmd_status() {
    echo "=== État des Interfaces ==="
    ip -br addr
    echo ""
    echo "=== Routes IPv4 ==="
    ip route
    echo ""
    echo "=== Routes IPv6 ==="
    ip -6 route
}

cmd_reload() {
    if [ -f /etc/init.d/yarp ]; then
        /etc/init.d/yarp reload
    else
        cmd_apply
    fi
}

cmd_version() {
    echo "YARP version $YARP_VERSION"
}

# Main
if [ $# -eq 0 ]; then
    show_help
    exit 0
fi

case "$1" in
    apply)
        cmd_apply
        ;;
    validate)
        cmd_validate
        ;;
    show)
        cmd_show
        ;;
    status)
        cmd_status
        ;;
    reload)
        cmd_reload
        ;;
    version)
        cmd_version
        ;;
    help|--help|-h)
        show_help
        ;;
    *)
        echo "Commande inconnue: $1"
        echo "Utilisez 'yarp help' pour voir les commandes disponibles"
        exit 1
        ;;
esac
